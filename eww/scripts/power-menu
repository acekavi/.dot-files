#!/bin/bash
# #######################################################################################
# EWW POWER MENU SCRIPT - SIMPLE AND CLEAN
# Handles power menu actions for the eww status bar
# #######################################################################################

action="$1"

case "$action" in
    "lock")
        # Close power menu first
        eww update reveal-power=false
        # Simple lock with minimal hyprlock
        notify-send "üîí Locking Screen" "Touch fingerprint sensor..." -t 1500
        hyprlock --config ~/.config/hypr/hyprlock.conf
        ;;
    "sleep")
        # Open custom EWW confirmation dialog
        eww update reveal-power=false
        eww open confirm
        eww update confirm-text="Are you sure you want to sleep?"
        eww update confirm-action="sleep"
        eww update confirm-visible=true
        ;;
    "restart")
        # Open custom EWW confirmation dialog
        eww update reveal-power=false
        eww open confirm
        eww update confirm-text="Are you sure you want to restart?"
        eww update confirm-action="restart"
        eww update confirm-visible=true
        ;;
    "shutdown")
        # Open custom EWW confirmation dialog
        eww update reveal-power=false
        eww open confirm
        eww update confirm-text="Are you sure you want to shutdown?"
        eww update confirm-action="shutdown"
        eww update confirm-visible=true
        ;;

    # Custom confirmation dialog callbacks
    "confirm")
        action_to_run=$(eww get confirm-action)
        eww update confirm-visible=false
        eww close confirm
        eww update reveal-power=false
        case "$action_to_run" in
            "sleep")
                if command -v busctl >/dev/null 2>&1; then
                    if ! busctl call org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager Suspend b true >/dev/null 2>&1; then
                        if ! systemctl suspend >/dev/null 2>&1; then
                            notify-send "Error" "Failed to suspend system" -u critical
                        fi
                    fi
                else
                    if ! systemctl suspend >/dev/null 2>&1; then
                        notify-send "Error" "Failed to suspend system" -u critical
                    fi
                fi
                ;;
            "restart")
                if command -v busctl >/dev/null 2>&1; then
                    if ! busctl call org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager Reboot b true >/dev/null 2>&1; then
                        if ! systemctl reboot >/dev/null 2>&1; then
                            notify-send "Error" "Failed to restart system" -u critical
                        fi
                    fi
                else
                    if ! systemctl reboot >/dev/null 2>&1; then
                        notify-send "Error" "Failed to restart system" -u critical
                    fi
                fi
                ;;
            "shutdown")
                if command -v busctl >/dev/null 2>&1; then
                    if ! busctl call org.freedesktop.login1 /org/freedesktop/login1 org.freedesktop.login1.Manager PowerOff b true >/dev/null 2>&1; then
                        if ! systemctl poweroff >/dev/null 2>&1; then
                            notify-send "Error" "Failed to shutdown system" -u critical
                        fi
                    fi
                else
                    if ! systemctl poweroff >/dev/null 2>&1; then
                        notify-send "Error" "Failed to shutdown system" -u critical
                    fi
                fi
                ;;
            *)
                notify-send "‚ö†Ô∏è Unknown" "Unknown confirm-action: $action_to_run" -t 4000
                ;;
        esac
        ;;

    "cancel")
        eww update confirm-visible=false
        eww close confirm
        notify-send "Cancelled" "Action cancelled" -t 2500
        ;;
    "toggle")
        current=$(eww get reveal-power)
        if [[ "$current" == "true" ]]; then
            eww update reveal-power=false
        else
            eww update reveal-power=true
        fi
        ;;
    *)
        echo "Usage: $0 {lock|sleep|restart|shutdown|toggle}"
        exit 1
        ;;
esac